<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movement description using onomatopoeia</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    
</head>

    

    

    
<body class="bg-gray-100">
    
    <div class="container">
        <!-- Language selector at top of container, aligned right -->
        <div class="language-selector-container">
            <select id="languageSelect" class="language-dropdown">
                <option value="en">English</option>
                <option value="ja">日本語</option>
            </select>
        </div>        
        
        <div class="input-group">
            <p id="nameDisplay"></p>
            <button id="buttonLogout" class="button">Logout</button>
        </div>

        <!-- Video -->
        <p id="videoTitle">Video</p>
        <div class="video-container">
            <video
                id="myVideo"
                src="videos/1.mp4" 
                controls
                title="point light motion"
            >
                Your browser does not support the video tag.
            </video>
        </div>

        <!-- Video Selection Buttons -->
        <div class="video-buttons-container">
            <h3 id="selectVideoTitle">Select a video:</h3>
            <div id="videoButtons" class="video-buttons">
                <!-- Buttons will be populated here -->
            </div>
        </div>

        <h3 id="savedOnomatopoeiaTitle">Onomatopoeia already saved for this video:</h3>
        <p id="recordOnomatopoeia">None</p>
        <p id="output"></p>

        <div id="message" class="mt-4 text-gray-700"></div>

        <!-- Onomatopoeia -->
        <div class="input-group">
            <div id="buttonVisibility">
                <p id="questionText">Are there moments in this video that make you think of an onomatopoeia?</p>
                <div class="yes-no-buttons">
                    <button id="hasOnomatopoeiaButtonYes" class="button">Yes</button>
                    <button id="hasOnomatopoeiaButtonNo" class="button">No</button>
                </div>
            </div>
            <div id ="inputVisibility">
                <p id="step1Text">1) Please write the onomatopoeia you are thinking of:</p>

                <label id="onomatopoeiaLabel" for="onomatopoeiaInput">Onomatopoeia:</label>
                <textarea id="onomatopoeiaInput" name="onomatopoeiaInput" placeholder="Write your onomatopoeia"></textarea>

                <p id="step2Text">2) Place the cursor of the video player at where the movement that corresponds to the onomatopoeia begins and press the "Get starting time" button</p>
                <button id="getStart" class="button">Get starting time</button>
                <p id="startTimeLabel">Onomatopoeia Start Time:</p>
                <p id="startDisplay">-.--</p>

                <p id="step3Text">3) Place the cursor of the video player at where the movement that corresponds to the onomatopoeia ends and press the "Get ending time" button</p>
                <button id="getEnd" class="button">Get ending time</button>
                <p id="endTimeLabel">Onomatopoeia End Time:</p>
                <p id="endDisplay">-.--</p>

                <!-- Audio Recording Section -->
                <div id="audioSection" class="audio-section">
                    <p id="audioSectionTitle">4) Optional: Record audio of you pronouncing the onomatopoeia</p>
                    <div class="audio-controls">
                        <button id="audioRecord" class="button audio-button">Start Recording</button>
                        <button id="audioStop" class="button audio-button" style="display: none;">Stop Recording</button>
                        <button id="audioPlay" class="button audio-button" style="display: none;">Play Recording</button>
                        <button id="audioDelete" class="button audio-button audio-delete" style="display: none;">Delete Recording</button>
                    </div>
                    <div class="audio-status">
                        <p id="audioStatus">Ready to record</p>
                        <div id="audioWaveform" class="audio-waveform" style="display: none;">
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                        </div>
                    </div>
                </div>
    
                <button id="saveOnomatopoeia" class="button">Save Onomatopoeia</button>
            </div>
        </div>
        

    </div>

    <script src="./js/languageManager.js"></script>
    <script src="./js/sheetFun.js"></script>
    <script src="./js/fun.js"></script>
    <script>

        const nameDisplay = document.getElementById("nameDisplay");
        const buttonVisibility = document.getElementById("buttonVisibility");
        const inputVisibility = document.getElementById("inputVisibility");
        const hasOnomatopoeiaButtonYes = document.getElementById("hasOnomatopoeiaButtonYes");
        const hasOnomatopoeiaButtonNo = document.getElementById("hasOnomatopoeiaButtonNo");
        const buttonLogout = document.getElementById("buttonLogout");
        const videoTitle = document.getElementById("videoTitle");
        const videoPlayer = document.getElementById("myVideo");
        const videoButtons = document.getElementById('videoButtons');
        const getStart = document.getElementById("getStart");
        const startDisplay = document.getElementById("startDisplay");
        const getEnd = document.getElementById("getEnd");
        const endDisplay = document.getElementById("endDisplay");
        const onomatopoeiaInput = document.getElementById("onomatopoeiaInput");
        const saveOnomatopoeiaButton = document.getElementById("saveOnomatopoeia");
        const messageDisplay = document.getElementById("message");
        const recordOnomatopoeia = document.getElementById("recordOnomatopoeia");
        const questionText = document.getElementById("questionText");
        const languageSelect = document.getElementById("languageSelect");

        // Audio recording elements
        const audioRecord = document.getElementById("audioRecord");
        const audioStop = document.getElementById("audioStop");
        const audioPlay = document.getElementById("audioPlay");
        const audioDelete = document.getElementById("audioDelete");
        const audioStatus = document.getElementById("audioStatus");
        const audioWaveform = document.getElementById("audioWaveform");

        // Audio recording variables
        let mediaRecorder;
        let audioChunks = [];
        let recordedAudioBlob = null;
        let audioUrl = null;

        // Language switching functionality
        languageSelect.addEventListener("change", async (event) => {
            const selectedLanguage = event.target.value;
            await langManager.switchLanguage(selectedLanguage);
            // Update participant name when language changes
            nameDisplay.textContent = langManager.getText('survey.participant_name') + participantName;
            // Update audio status text if it exists
            if (audioStatus && !recordedAudioBlob) {
                audioStatus.textContent = langManager.getText('survey.audio_status_ready');
            }
        });

        
        const participantInfo = JSON.parse(localStorage.getItem("participantInfo"));
        //filtered data is the data corresponding to the participant ID
        let filteredData = JSON.parse(localStorage.getItem("filteredData"));
        /*
        const filteredData = [
            {
            "participantId": "3",
            "participantName": "test",
            "video": "1.mp4",
            "onomatopoeia": "oy",
            "startTime": "0.23",
            "endTime": "3.45",
            "answeredTimestamp": "12345"
            },// [object Object] 
            ...
        ]
        */

        // Only remove localStorage when user explicitly logs out
        // Don't remove on page load to allow recovery from refresh
        // localStorage.removeItem("participantInfo");
        // localStorage.removeItem("filteredData");

        if(!participantInfo){
            alert("Warning, no participant information found");
            window.location.href = "index.html";
        }

        const participantId = participantInfo.participantId;
        const participantEmail = participantInfo.email;
        const participantName = participantInfo.name || participantEmail; // Use name if available, otherwise email

        let currentVideoName;

        // Initialize language manager first, then set participant name
        langManager.initialize().then(() => {
            console.log('Language manager initialized on survey page');
            // Set participant name after language manager is ready
            nameDisplay.textContent = langManager.getText('survey.participant_name') + participantName;
        }).catch(error => {
            console.error('Failed to initialize language manager on survey page:', error);
            // Fallback to English text if language manager fails
            nameDisplay.textContent = "Participant: " + participantName;
        });

        // Load configuration from sheet-info.json
        // and populate the dropdown dynamically from SelectedVideos sheet
        let spreadsheetId, OnomatopoeiaSheet, videoSheet, ParticipantSheet;

        fetch('./sheet-info.json')
            .then(response => response.json())
            .then(config => {
                spreadsheetId = config.spreadsheetId;
                OnomatopoeiaSheet = config.OnomatopoeiaSheet;
                videoSheet = config.videoSheet;
                ParticipantSheet = config.ParticipantSheet;
                
                // --------- initial button creation
                // This will create buttons for each video in the SelectedVideos sheet

                return loadSelectedVideos(spreadsheetId, videoSheet, videoButtons); // Return the promise to chain it
            })
            .then(() => {// This executes after loadSelectedVideos completes
                
                // ------- initial video setup and display

                const firstButton = videoButtons.querySelector('button');
                const initialVideo = firstButton ? firstButton.dataset.video : "videos/1.mp4";
                videoPlayer.src = initialVideo;
                videoPlayer.load();
                videoTitle.textContent = `Video: ${initialVideo}`;

                // Ensure first button is marked as active
                if (firstButton) {
                    firstButton.classList.add('active');
                }

                currentVideoName = videoPlayer.src.split("/").pop();
                docElts = {
                    "onomatopoeiaInput": onomatopoeiaInput,
                    "startDisplay": startDisplay,
                    "endDisplay": endDisplay,
                    "recordOnomatopoeia": recordOnomatopoeia,
                    "buttonVisibility": buttonVisibility,
                    "inputVisibility": inputVisibility,
                    "questionText": questionText
                }
                //reset the display
                resetDisplay(currentVideoName, filteredData, docElts);
            })
            .catch(error => {
                console.error('Error loading sheet configuration:', error);
            });


        // ------------ event listeners

        // when click change Name button, come back to index.html
        buttonLogout.addEventListener("click", () => {
            // Clear localStorage when user explicitly logs out
            localStorage.removeItem("participantInfo");
            localStorage.removeItem("filteredData");
            window.location.href = "index.html";
        });


        // Update video source when video button is clicked
        videoButtons.addEventListener("click", (event) => {
            if (event.target.tagName === 'BUTTON') {
                // Clear any existing messages when changing videos
                UIUtils.clearMessage(messageDisplay);
                
                const selectedVideo = event.target.dataset.video;
                videoPlayer.src = selectedVideo;
                videoPlayer.load();
                videoTitle.textContent = `Video: ${selectedVideo}`;
                currentVideoName = selectedVideo.split("/").pop();
                resetDisplay(currentVideoName, filteredData, docElts);
                resetAudioRecording(); // Reset audio recording when changing videos
                
                // Update button styles to show active state
                videoButtons.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
            }
        });

        // when click on the button Yes (i see onomatopoeia), change the visibility of the input
        hasOnomatopoeiaButtonYes.addEventListener("click", () => {
            // Clear any existing messages when starting to input onomatopoeia
            UIUtils.clearMessage(messageDisplay);
            
            buttonVisibility.style.display = "none";
            inputVisibility.style.display = "block";
            resetAudioRecording(); // Reset audio when starting new input
        });

        // when click on the button No (no onomatopoeia), save null entry if needed and go to next video
        hasOnomatopoeiaButtonNo.addEventListener("click", () => {
            // Clear any existing messages when clicking "No"
            UIUtils.clearMessage(messageDisplay);
            
            // If no onomatopoeia has been saved yet, save a null entry
            const currentVideoData = filteredData.filter(item => item["video"] === currentVideoName);
            if (!currentVideoData.length){
                const infoDict = {
                    "participantId": participantId,
                    "participantName": participantName,
                    "video": currentVideoName,
                    "onomatopoeia": "null",
                    "startTime": "0",
                    "endTime": "0",
                    "answeredTimestamp": obtainDate(),
                    "hasAudio": "no"
                };
                
                // Wait for the save to complete before proceeding
                saveOnomatopoeia(filteredData, infoDict, spreadsheetId, OnomatopoeiaSheet, messageDisplay, verbose = false)
                    .then(() => {
                        // Now go to next video AFTER successful save
                        const currentButton = videoButtons.querySelector('button.active');
                        goToNextVideo(currentButton); // simulate a click on the sibling video button
                    })
                    .catch(error => {
                        console.error("Error saving onomatopoeia:", error);
                        // Don't proceed to next video if save failed
                    });
            } else {
                // If already saved, just go to next video
                const currentButton = videoButtons.querySelector('button.active');
                goToNextVideo(currentButton);
            }
        });

        

        // get and display the current timestamp
        getStart.addEventListener("click", () => {
            const currentTime = videoPlayer.currentTime;
            startDisplay.textContent = `${currentTime.toFixed(2)}`;
        });

        getEnd.addEventListener("click", () => {
            const currentTime = videoPlayer.currentTime;
            endDisplay.textContent = `${currentTime.toFixed(2)}`;
        });


        // when save button is clicked
        saveOnomatopoeiaButton.addEventListener("click", () => {
            infoDict = {
                "participantId": participantId,
                "participantName": participantName,
                "video": currentVideoName,
                "onomatopoeia": onomatopoeiaInput.value.trim(),
                "startTime": startDisplay.textContent,
                "endTime": endDisplay.textContent,
                "answeredTimestamp": obtainDate(),
                "hasAudio": recordedAudioBlob ? "yes" : "no",
                "audioBlob": recordedAudioBlob
            };

            saveOnomatopoeia(filteredData, infoDict, spreadsheetId, OnomatopoeiaSheet, messageDisplay).then(() => {
                // Also update local data and display with the new data
                resetDisplay(currentVideoName, filteredData, docElts);
            }).catch(error => {
                console.error("Error saving onomatopoeia:", error);
            });
        });

        // Audio recording event listeners
        audioRecord.addEventListener("click", async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    recordedAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    audioUrl = URL.createObjectURL(recordedAudioBlob);
                    
                    // Update UI
                    audioStatus.textContent = langManager.getText('survey.audio_status_recorded');
                    audioWaveform.style.display = 'none';
                    audioWaveform.classList.remove('audio-recording');
                    
                    // Show control buttons
                    audioRecord.style.display = 'none';
                    audioStop.style.display = 'none';
                    audioPlay.style.display = 'inline-block';
                    audioDelete.style.display = 'inline-block';
                    
                    // Stop all tracks to free up microphone
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                
                // Update UI
                audioStatus.textContent = langManager.getText('survey.audio_status_recording');
                audioWaveform.style.display = 'flex';
                audioWaveform.classList.add('audio-recording');
                
                // Show/hide buttons
                audioRecord.style.display = 'none';
                audioStop.style.display = 'inline-block';
                audioPlay.style.display = 'none';
                audioDelete.style.display = 'none';
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                if (error.name === 'NotAllowedError') {
                    audioStatus.textContent = langManager.getText('survey.audio_permission_denied');
                } else {
                    audioStatus.textContent = langManager.getText('survey.audio_not_supported');
                }
            }
        });

        audioStop.addEventListener("click", () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        });

        audioPlay.addEventListener("click", () => {
            if (audioUrl) {
                const audio = new Audio(audioUrl);
                audioStatus.textContent = langManager.getText('survey.audio_status_playing');
                audioWaveform.style.display = 'flex';
                audioWaveform.classList.add('audio-playing');
                
                audio.onended = () => {
                    audioStatus.textContent = langManager.getText('survey.audio_status_recorded');
                    audioWaveform.style.display = 'none';
                    audioWaveform.classList.remove('audio-playing');
                };
                
                audio.play();
            }
        });

        audioDelete.addEventListener("click", () => {
            // Clean up audio data
            if (audioUrl) {
                URL.revokeObjectURL(audioUrl);
                audioUrl = null;
            }
            recordedAudioBlob = null;
            audioChunks = [];
            
            // Reset UI
            audioStatus.textContent = langManager.getText('survey.audio_status_ready');
            audioWaveform.style.display = 'none';
            audioWaveform.classList.remove('audio-recording', 'audio-playing');
            
            // Reset buttons
            audioRecord.style.display = 'inline-block';
            audioStop.style.display = 'none';
            audioPlay.style.display = 'none';
            audioDelete.style.display = 'none';
        });

        // Reset audio recording when changing videos
        function resetAudioRecording() {
            // Clean up audio data
            if (audioUrl) {
                URL.revokeObjectURL(audioUrl);
                audioUrl = null;
            }
            recordedAudioBlob = null;
            audioChunks = [];
            
            // Reset UI
            if (audioStatus) {
                audioStatus.textContent = langManager.getText('survey.audio_status_ready');
            }
            if (audioWaveform) {
                audioWaveform.style.display = 'none';
                audioWaveform.classList.remove('audio-recording', 'audio-playing');
            }
            
            // Reset buttons
            if (audioRecord) audioRecord.style.display = 'inline-block';
            if (audioStop) audioStop.style.display = 'none';
            if (audioPlay) audioPlay.style.display = 'none';
            if (audioDelete) audioDelete.style.display = 'none';
        }

        // Make resetAudioRecording available globally
        window.resetAudioRecording = resetAudioRecording;

    
    </script>

        
    
</body>
</html>
