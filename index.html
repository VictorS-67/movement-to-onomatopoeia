<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movement to Onomatopoeia - Participant Login</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    
</head>

    
<body class="bg-gray-100">
    
    <!-- Language selector in top right -->
    <div class="language-selector">
        <select id="languageSelect" class="language-dropdown">
            <option value="en">English</option>
            <option value="ja">日本語</option>
        </select>
    </div>
    
    <div class="container">        
        <form id="emailForm" class="input-group">
            <label id="emailLabel" for="emailInput">Your email address:</label>
            <input type="email" id="emailInput"
             name="emailInput" placeholder="Enter your email address"
             required>
            <button type="submit" id="nextButton" class="button">Next</button>
        </form>

        <!-- Language selection and introductory text -->
        <div id="introSection" style="display: none;">
            <div id="introText" class="intro-text">
                <h2 id="welcomeTitle">Welcome to the Movement to Onomatopoeia Study</h2>
                <p>
                    <span id="welcomeIntro">Loading...</span>
                    <br>
                    <span id="welcomeDescription">Loading...</span>
                </p>
                
                <h3 id="instructionsTitle">What you'll do:</h3>
                <ul id="instructionsList">
                    <li>Loading...</li>
                </ul>

                <p id="noOnomatopoeia">Loading...</p>
                
                <p>
                    <span id="aboutOnomatopoeia">Loading...</span>
                    <strong id="intuitionEmphasis">Loading...</strong>
                </p>
            </div>
        </div>
        
        <form id="participantForm" class="input-group" style="display: none;">
            <h2 id="profileTitle">Welcome! Please complete your profile:</h2>
            <label id="nameLabel" for="nameInput">Your name/pseudo:</label>
            <input type="text" id="nameInput" name="nameInput" 
                   placeholder="Enter your name or pseudonym" 
                   required minlength="2" maxlength="50">
            
            <label id="ageLabel" for="ageInput">Your age:</label>
            <input type="number" id="ageInput" name="ageInput" 
                   placeholder="Enter your age" 
                   min="1" max="120" required>

            <label id="genderLabel" for="genderInput">Your gender:</label>
            <select id="genderInput" name="genderInput" required>
                <option value="">Please select...</option>
                <option value="Female">Female</option>
                <option value="Male">Male</option>
                <option value="Other">Other</option>
                <option value="Prefer not to say">Prefer not to say</option>
            </select>

            <label id="movementPracticeLabel" for="movementPracticeInput">Your movement practice (optional):</label>
            <input type="text" id="movementPracticeInput" name="movementPracticeInput" 
                   placeholder="e.g., dance, somatics, manual therapy, movement analysis..." 
                   maxlength="100">

            <label id="nativeLanguageLabel" for="nativeLanguageInput">Your native language:</label>
            <select id="nativeLanguageInput" name="nativeLanguageInput" required>
                <option value="">Please select...</option>
                <option value="Japanese">Japanese</option>
                <option value="English">English</option>
                <option value="Other">Other</option>
            </select>

            <button type="submit" id="submitButton" class="button">Start the survey</button>
        </form>

        <div id="message" class="mt-4 text-gray-700"></div>
    </div>

    
    <script src="./js/languageManager.js"></script>
    <script src="./js/sheetFun.js"></script>
    <script src="./js/fun.js"></script>
    <script>

        const emailForm = document.getElementById("emailForm");
        const participantForm = document.getElementById("participantForm");
        const introSection = document.getElementById("introSection");
        const languageSelect = document.getElementById("languageSelect");
        const emailInput = document.getElementById("emailInput");
        const nameInput = document.getElementById("nameInput");
        const ageInput = document.getElementById("ageInput");
        const genderInput = document.getElementById("genderInput");
        const movementPracticeInput = document.getElementById("movementPracticeInput");
        const nativeLanguageInput = document.getElementById("nativeLanguageInput");
        const messageDisplay = document.getElementById("message");

        // Initialize language manager
        langManager.initialize().then(() => {
            console.log('Language manager initialized');
        }).catch(error => {
            console.error('Failed to initialize language manager:', error);
        });

        // Load configuration from sheet-info.json
        let spreadsheetId, OnomatopoeiaSheet, videoSheet, ParticipantSheet;
        
        fetch('./sheet-info.json')
            .then(response => response.json())
            .then(config => {
                spreadsheetId = config.spreadsheetId;
                OnomatopoeiaSheet = config.OnomatopoeiaSheet;
                videoSheet = config.videoSheet;
                ParticipantSheet = config.ParticipantSheet;
            })
            .catch(error => {
                console.error('Error loading sheet configuration:', error);
            });

        let data = []

        // Language switching functionality
        languageSelect.addEventListener("change", async (event) => {
            const selectedLanguage = event.target.value;
            await langManager.switchLanguage(selectedLanguage);
        });

        emailForm.addEventListener("submit", async (event) => {
            event.preventDefault(); // Prevent default form submission
            
            const email = emailInput.value.trim();

            try {
                messageDisplay.textContent = langManager.getText('ui.checking_participant');
                messageDisplay.style.color = "blue";

                // Check if participant exists
                const existingParticipantInfo = await checkParticipantExists(spreadsheetId, ParticipantSheet, email);

                if (existingParticipantInfo) {
                    // Returning participant Info (a dictionnary)
                    localStorage.setItem("participantInfo", JSON.stringify(existingParticipantInfo));

                    // Get their existing data
                    const sheetData = await getSheetData(spreadsheetId, OnomatopoeiaSheet);
                    const filteredData = parseCSV(sheetData).filter(item => item["participantId"] === existingParticipantInfo.participantId);
                    localStorage.setItem("filteredData", JSON.stringify(filteredData));
                    
                    // Redirect to survey
                    window.location.href = "survey.html";
                } else {
                    // New participant - show intro section and registration form
                    introSection.style.display = "block";
                    participantForm.style.display = "block";
                    messageDisplay.textContent = langManager.getText('ui.welcome_message');
                    messageDisplay.style.color = "green";
                }
            } catch (error) {
                messageDisplay.textContent = langManager.getText('ui.error_checking');
                messageDisplay.style.color = "red";
                console.error("Error:", error);
            }
        });

        participantForm.addEventListener("submit", async (event) => {
            event.preventDefault(); // Prevent default form submission
            
            const email = emailInput.value.trim();
            const name = nameInput.value.trim();
            const age = ageInput.value.trim();
            const gender = genderInput.value;
            const movementPractice = movementPracticeInput.value.trim();
            const nativeLanguage = nativeLanguageInput.value;

            try {
                messageDisplay.textContent = langManager.getText('ui.creating_profile');
                messageDisplay.style.color = "blue";

                
                // Save new participant
                const participantData = {
                    email: email,
                    name: name,
                    age: age,
                    gender: gender,
                    movementPractice: movementPractice,
                    nativeLanguage: nativeLanguage
                };

                // Save participant data to Google Sheets and
                // get its unique ID
                const participantId = await saveNewParticipant(spreadsheetId, ParticipantSheet, participantData);

                // Add participantId to participantData
                participantData.participantId = participantId;
                // Store participant info in localStorage
                localStorage.setItem("participantInfo", JSON.stringify(participantData));
                localStorage.setItem("filteredData", JSON.stringify([])); // Empty for new participant

                // Redirect to survey
                window.location.href = "survey.html";
            } catch (error) {
                messageDisplay.textContent = langManager.getText('ui.error_creating');
                messageDisplay.style.color = "red";
                console.error("Error:", error);
            }
        });

    </script>
    
</body>
</html>
